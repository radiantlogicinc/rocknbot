# Use a slim Python base image with uv for fast dependency installation
FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends git && rm -rf /var/lib/apt/lists/*

# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Set the working directory in the container
WORKDIR /app

# Install PyTorch with CUDA support (large, cached separately)
RUN --mount=type=cache,target=/root/.cache/uv \
    uv pip install --system torch --index-url https://download.pytorch.org/whl/cu126

# Install remaining dependencies from pyproject.toml
COPY pyproject.toml /app/
RUN --mount=type=cache,target=/root/.cache/uv \
    uv pip install --system --index-strategy unsafe-best-match --extra-index-url https://download.pytorch.org/whl/cu126 .

# Copy the app code and files to the container
COPY data /app/data
COPY env /app/env
COPY passwords /app/passwords
COPY src /app/src

RUN mkdir speedict

ENV PYTHONUNBUFFERED=1

# Set the CMD to your handler
ENTRYPOINT ["uvicorn", "src.main:app", "--host=0.0.0.0"]
